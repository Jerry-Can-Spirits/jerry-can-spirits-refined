---
// src/components/AgeGate.astro
---

<div id="age-gate-overlay">
  <div id="age-gate-modal">
    <div class="logo-container">
      <img 
        src="/logo-primary.png" 
        alt="Jerry Can Spirits Logo" 
        width="150"
        height="50"
        loading="eager"
      />
    </div>
    
    <h2>Age Verification</h2>
    <p>You must be of legal drinking age to enter this site. Please enter your date of birth.</p>
    
    <form id="age-gate-form">
      <div class="dob-inputs">
        <div class="input-group">
          <label for="dob-day">Day</label>
          <select id="dob-day" required aria-label="Day of birth">
            <option value="">DD</option>
          </select>
        </div>
        
        <div class="input-group">
          <label for="dob-month">Month</label>
          <select id="dob-month" required aria-label="Month of birth">
            <option value="">MM</option>
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        
        <div class="input-group">
          <label for="dob-year">Year</label>
          <select id="dob-year" required aria-label="Year of birth">
            <option value="">YYYY</option>
          </select>
        </div>
      </div>
      
      <button type="submit" class="submit-button" id="verify-age-btn">
        <span class="button-text">Enter Site</span>
        <span class="button-loader"></span>
      </button>
    </form>
    
    <p id="age-gate-error" class="error-message" role="alert" aria-live="polite"></p>
    
    <p class="responsible-drinking">
      Please drink responsibly. For more information, visit 
      <a href="https://www.drinkaware.co.uk" target="_blank" rel="noopener noreferrer">
        drinkaware.co.uk
      </a>
    </p>
  </div>
</div>

<script>
  function setCookie(name: string, value: string, days: number) {
    let expires = "";
    if (days) {
      const date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
  }

  function getCookie(name: string) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) === ' ') c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
  }

  // Populate dropdowns and initialize
  document.addEventListener('DOMContentLoaded', () => {
    const ageGateOverlay = document.getElementById('age-gate-overlay');
    const ageGateForm = document.getElementById('age-gate-form');
    const errorMessage = document.getElementById('age-gate-error');
    const daySelect = document.getElementById('dob-day') as HTMLSelectElement;
    const monthSelect = document.getElementById('dob-month') as HTMLSelectElement;
    const yearSelect = document.getElementById('dob-year') as HTMLSelectElement;
    const submitButton = document.getElementById('verify-age-btn') as HTMLButtonElement;

    if (!ageGateOverlay || !ageGateForm || !errorMessage || !daySelect || !monthSelect || !yearSelect) {
      console.error('Age Gate component is missing required elements');
      return;
    }

    // Populate days (1-31)
    for (let i = 1; i <= 31; i++) {
      const option = document.createElement('option');
      option.value = i.toString();
      option.textContent = i.toString().padStart(2, '0');
      daySelect.appendChild(option);
    }

    // Populate years (current year - 100 to current year)
    const currentYear = new Date().getFullYear();
    for (let i = currentYear; i >= currentYear - 100; i--) {
      const option = document.createElement('option');
      option.value = i.toString();
      option.textContent = i.toString();
      yearSelect.appendChild(option);
    }

    // Update days based on month/year selection
    function updateDays() {
      const month = parseInt(monthSelect.value);
      const year = parseInt(yearSelect.value);
      if (!month) return;

      const daysInMonth = new Date(year || 2024, month, 0).getDate();
      const currentDay = parseInt(daySelect.value);

      // Clear and repopulate days
      daySelect.innerHTML = '<option value="">DD</option>';
      for (let i = 1; i <= daysInMonth; i++) {
        const option = document.createElement('option');
        option.value = i.toString();
        option.textContent = i.toString().padStart(2, '0');
        if (i === currentDay) option.selected = true;
        daySelect.appendChild(option);
      }
    }

    monthSelect.addEventListener('change', updateDays);
    yearSelect.addEventListener('change', updateDays);

    // Check if user is already verified
    if (getCookie('ageGateVerified') !== 'true') {
      ageGateOverlay.classList.add('visible');
      // Prevent scrolling when age gate is open
      document.body.style.overflow = 'hidden';
    }

    // Form submission
    ageGateForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      errorMessage.textContent = '';

      const day = parseInt(daySelect.value);
      const month = parseInt(monthSelect.value);
      const year = parseInt(yearSelect.value);

      // Validation
      if (!day || !month || !year) {
        errorMessage.textContent = 'Please enter your complete date of birth.';
        return;
      }

      // Add loading state
      submitButton.classList.add('loading');
      submitButton.disabled = true;

      // Simulate processing (remove in production)
      await new Promise(resolve => setTimeout(resolve, 500));

      const birthDate = new Date(year, month - 1, day);
      const today = new Date();
      
      // Calculate age
      let age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }

      // Remove loading state
      submitButton.classList.remove('loading');
      submitButton.disabled = false;

      if (age >= 18) {
        setCookie('ageGateVerified', 'true', 30);
        ageGateOverlay.classList.remove('visible');
        document.body.style.overflow = '';
        
        // Dispatch event for analytics
        window.dispatchEvent(new CustomEvent('ageVerified', { detail: { age } }));
      } else {
        errorMessage.textContent = 'Sorry, you must be 18 or over to enter this site.';
        
        // Clear form
        daySelect.value = '';
        monthSelect.value = '';
        yearSelect.value = '';
      }
    });

    // Keyboard navigation
    ageGateOverlay.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        e.preventDefault(); // Prevent closing
      }
    });
  });
</script>